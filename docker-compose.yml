services:
  airflow:
    build:
      dockerfile: Dockerfile
    container_name: stockelper-airflow
    environment:
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__CORE__PLUGINS_FOLDER=/opt/airflow/plugins
      - AIRFLOW__CORE__BASE_LOG_FOLDER=/opt/airflow/logs
      - AIRFLOW__CORE__LOGGING_LEVEL=INFO
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DEFAULT_TIMEZONE=UTC
      - AIRFLOW__WEBSERVER__WEB_SERVER_PORT=21003
      - AIRFLOW__WEBSERVER__BASE_URL=http://localhost:21003
      - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW_SECRET_KEY}
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db
      - AIRFLOW_ADMIN_USERNAME=${AIRFLOW_ADMIN_USERNAME:-admin}
      - AIRFLOW_ADMIN_PASSWORD=${AIRFLOW_ADMIN_PASSWORD:-admin}
      - AIRFLOW_ADMIN_EMAIL=${AIRFLOW_ADMIN_EMAIL:-admin@stockelper.com}
      - MONGODB_URI=${MONGODB_URI}
      - MONGO_DATABASE=${MONGO_DATABASE:-stockelper}
      - PYTHONPATH=/opt/airflow
    ports:
      - "21003:8080"   # Webserver
    volumes:
      - airflow_logs:/opt/airflow/logs
      - airflow_db:/opt/airflow
    networks:
      - stockelper
    command: >
      bash -c "
        airflow db init &&
        airflow users create --username $${AIRFLOW_ADMIN_USERNAME} --firstname Admin --lastname User --role Admin --email $${AIRFLOW_ADMIN_EMAIL} --password $${AIRFLOW_ADMIN_PASSWORD} || true &&
        airflow scheduler &
        airflow webserver
      "
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  airflow_logs:
  airflow_db:

networks:
  stockelper:
    driver: bridge
    name: stockelper
    external: true
